window.addEventListener("DOMContentLoaded", (e) => {
    document.body.addEventListener("click", vote);
    document.querySelectorAll(".voteCount").forEach(counter => getVoteCount(counter)); //voteCounters for questions and answers should include this class
});

async function getVoteCount(counter){
    const [firstPart ,id] = counter.id.split("For");
    const pathName = firstPart.includes("answer") ? "answers" : "questions";
    fetch(`http://localhost:8080/${pathName}/${id}/vote/`)
    .then(res => res.json())
    .then(json => counter.innerHTML = json.count);
}

async function vote(e) {
    const clicked = e.target.id; // all question vote buttons need an id of the format upVoteFor420 or downVoteFor2020 generated by the templet
    if(!clicked.includes("VoteFor")) return;
    e.preventDefault();
    if(clicked.includes("AnswerVote")) return answerVote(e); // all answer vote buttons neeed and id of the format upAnswerVoteFor42 or downAnswerVoteFor11
    let [isUpVote, questionId] = clicked.split("For");
    isUpVote = (isUpVote === "upVote");
    const res = await fetch(`http://localhost:8080/questions/${questionId}/vote`, {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({isUpVote})
    }).catch(e => console.log(e));
    if(res.redirected) return window.location = res.url;
    const {count} = await res.json();
    document.querySelector(`#voteCountFor${questionId}`).innerHTML = count;
}

async function answerVote(e) {
    const clicked = e.target.id;
    let [isUpVote, answerId] = clicked.split("For");
    isUpVote = (isUpVote === "upAnswerVote");
    const res = await fetch(`http://localhost:8080/answers/${answerId}/vote`, {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({isUpVote})
    }).catch(e => console.log(e));
    if(res.redirected) return window.location = res.url;
    const {count} = await res.json();
    document.querySelector(`#answerVoteCountFor${answerId}`).innerHTML = count;
}
